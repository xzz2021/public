é¡ºä¸°ä¸‹å•åŠäº‘æ‰“å°æ¥å£å¯¹æ¥(jsç‰ˆ)

##### [é¡ºä¸°å¼€æ”¾å¹³å°](https://open.sf-express.com/)æ³¨å†Œè´¦å·å¹¶è®¤è¯, æ–°å»ºå¼€å‘è€…åº”ç”¨,é€‰æ‹©ç›¸åº”æ¥å£åˆ†ç±», å…³è”API, é€‰æ‹©éœ€è¦å¼€å‘çš„æ¥å£;æ‰€æœ‰æ¥å£éœ€è¿›è¡Œæ²™ç®±æµ‹è¯•, æˆåŠŸ3æ¬¡åæ‰å¯ä»¥ä¸Šçº¿ç”Ÿäº§. [å‚è€ƒæ–‡ç« ](https://blog.csdn.net/qq_18948359/article/details/137097749)

#### ä¸‹å•æ¥å£

1. ä¸‹å•è¯¦ç»†[è¯´æ˜æ–‡æ¡£]([é¡ºä¸°å¼€æ”¾å¹³å°](https://open.sf-express.com/Api/ApiDetails?level3=393&interName=ä¸‹è®¢å•æ¥å£-EXP_RECE_CREATE_ORDER)), æ•°æ®æœ‰2ç§ç­¾ååŠ å¯†æ–¹å¼, å¯ä»¥äºŒé€‰ä¸€: æ•°å­—ç­¾åå’ŒOAuth2

2. å‰ç½®æ¡ä»¶: å®˜ç½‘è·å– `checkWord`  `monthlyCard(æœˆä»˜å¡)` `partnerID`

3. æ•°æ®æ„é€ /æ ¼å¼è½¬æ¢/[æ•°å­—ç­¾åè®¤è¯](https://open.sf-express.com/developSupport/976720?authId=1)

   ```ts
   import { v4 as uuidv4 } from 'uuid';
   import crypto from 'node:crypto'; 
   sign(msgDataStr: string, timestamp: number): string {
       const text = msgDataStr + timestamp + this.checkWord;
       const toVerifyText = encodeURIComponent(text).replace(/%20/g, '+');
       const md5 = crypto.createHash('md5').update(toVerifyText,'utf8').digest().toString('base64');
       return md5;
     }
   //  åŠ å·¥éœ€è¦ä¼ é€’çš„æ•°æ®
   generateBaseData(msgData: object) {
       const timestamp = Date.now();
       const uuid = uuidv4();
       const msgDataStr = JSON.stringify(msgData);
       const msgDigest = this.sign(msgDataStr, timestamp);
       const baseData =  {
         partnerID: 'GVHUF78sdfse8G', // å®¢æˆ·ç¼–å·
         serviceCode: 'EXP_RECE_CREATE_ORDER',  // ä¸šåŠ¡ç±»å‹
         timestamp: timestamp.toString(),
         requestID: uuid,
         msgData: msgDataStr,
         msgDigest,
       };
       const body = new URLSearchParams(baseData).toString()
       return body
     }
   ```

4. è¯·æ±‚ä¸‹å•

   ```ts
    async createOrder(msgData: object): Promise<any> {
        const createOrderUrl = this.isSbox ? 'https://sfapi-sbox.sf-express.com/std/service' : 'https://bspgw.sf-express.com/std/service';
        const body = generateBaseData(data)
           const res = await fetch(createOrderUrl, {
         method: 'POST',
         headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
         body,
       });
       if (!res.ok) {
         throw new Error(`HTTP error! Status: ${res.status}`);
       }
       return await res.json();
   }
   //  createOrderå“åº”æ•°æ®åœ¨apiResultDataä¸­, éœ€è¦JSON parse
   //  å¿«é€’å•å·åœ¨JSON.parse(apiResultData)?.msgData?.waybillNoInfoList[0]?.waybillNo
   ```

5. [OAuth2è®¤è¯è¯´æ˜](https://open.sf-express.com/developSupport/976720?authId=0), æ³¨æ„æ²™ç®±ç”¨æ²™ç®±tokenå’Œè®¢å•å·,ç”Ÿäº§ç”¨ç”Ÿäº§tokenå’Œè®¢å•å·

   ```ts
    async getOAuth2Token() {
       const url = this.isSbox ? 'https://sfapi-sbox.sf-express.com/oauth2/accessToken' : 'https://sfapi.sf-express.com/oauth2/accessToken';
       const body = new URLSearchParams({
         partnerID:  'GVH787878678G', // å®¢æˆ·ç¼–å·
         secret: 'checkWordsd787his345',  // æ ¡éªŒç 
         grantType: 'password',  // å›ºå®šå­—ç¬¦
       });
       const res = await fetch(url, {
         method: 'POST',
         headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
         body,
       });
       if (!res.ok) {
         throw new Error(`HTTP error! Status: ${res.status}`);
       }
       const { accessToken } = await res.json();
       if (!accessToken) {
         throw new Error('è·å–accessTokenå¤±è´¥');
       }
       return accessToken;
     }
   
   ```

6. å•å·ç‰©æµæŸ¥è¯¢

   ```ts
     async LogisticsQuery(waybillNo: string): Promise<any> {
       const msgData = {
         language: 0, //  0ï¼šä¸­æ–‡ 1ï¼šè‹±æ–‡ 2ï¼šç¹ä½“
         trackingType: 1, // 1. é¡ºä¸°è¿å•å·  2. å®¢æˆ·è®¢å•å·
         trackingNumber: [waybillNo],
       };
       const baseData = this.generateBaseData({ serviceCode: 'EXP_RECE_SEARCH_ROUTES', msgData });
       const res = await this.fetchWrap(this.logisticsQueryUrl, baseData);
       const newRes = res?.msgData?.routeResps[0];
       if (newRes?.mailNo) {
         return newRes;
       } else {
         return res;
       }
     }
   ```

#### æ‰“å°é¢å•æ¥å£

1. äº‘æ‰“å°é¢å•æ‰“å°æ’ä»¶æ¥å£, å‰ç½®æ¡ä»¶: æ‰“å°æœºè¿æ¥ç”µè„‘,è£…å¥½é©±åŠ¨, å®‰è£…`é¡ºä¸°äº‘æ‰“å°æ’ä»¶`, [å‰ç«¯SDKåŒ…](https://scp-tcdn.sf-express.com/prd/sdk/lodop/2.7/SCPPrint.js), å³é”®ä¿å­˜ä¸ç„¶ä¼šæœ‰ç¼–ç é—®é¢˜, ([å®˜æ–¹æ–‡æ¡£](https://open.sf-express.com/Api/ApiDetails?level3=324&interName=äº‘æ‰“å°é¢å•æ‰“å°æ’ä»¶æ¥å£-COM_RECE_CLOUD_PRINT_PARSEDDATA))

2. æ­¤æ’ä»¶æ¥å£apiæ˜¯ç›´æ¥åœ¨å‰ç«¯ä½¿ç”¨SDKå‘èµ·

   ```ts
   //  SCPPrintå‡½æ•°æ¥è‡ªSDKåŒ…,è²Œä¼¼æŒ‚è½½åœ¨å…¨å±€windowä¸Š
   const sfPrint = new SCPPrint({ partnerID: 'DYJ778979I6Z3', 
                  // env: 'sbox'
        })
   const accessToken = await getOAuth2Token() // å‘åç«¯è¯·æ±‚token
   const requestID = uuidv4()  // å”¯ä¸€ID éšæœºæ•°ä¹Ÿå¯ä»¥ ç”¨äºæº¯æº
     sfPrint.print(
       {
         requestID,
         accessToken,
         templateCode: 'fm_76130_standard_DYJ465786Z3', // ç±»ä¼¼ï¼šfm_76130_standard_{partnerId}
         documents: [
           {
             masterWaybillNo: 'SF7454654706873'  // è¦æ‰“å°çš„é¡ºä¸°å•å·
           }
         ]
       },
       (res) => {   // å›è°ƒå‡½æ•°
           if (res?.code === 1) {
           console.log('ğŸš€ ~ xzz: æ‰“å°æˆåŠŸ ~ res')
         }
         
       }
     )
   ```

3. å®ç°åŸç†(åˆæ­¥ç†è§£): sdkæºå¸¦tokenå‘èµ·è¯·æ±‚ç»™é¡ºä¸°å®˜æ–¹æ¥å£, æ¥å£æ ¸å¯¹èº«ä»½ä¿¡æ¯,æŸ¥æ‰¾åˆ°å½“å‰è®¢å•ä¿¡æ¯è¿”å›ç»™sdk,  ç”µè„‘å®‰è£…çš„äº‘æ‰“å°æ’ä»¶æœ‰å»ºç«‹websocketé€šä¿¡,é»˜è®¤8000ç«¯å£,sdkå°†å¾…æ‰“å°ä¿¡æ¯å‘é€ç»™ws,ä»è€Œå®ç°æ‰“å°.

4. åç»­è¿˜éœ€è¦æ·»åŠ åˆ›å»ºè‡ªå®šä¹‰äº‘é¢å•åŠŸèƒ½,ä»è€Œè‡ªå®šä¹‰æ‰“å°å‚æ•°åŠè„±æ•æ˜¾éšç­‰

5. å®Œæ•´ç¤ºä¾‹ä»£ç demo

   ```ts
   import { v4 as uuidv4 } from 'uuid';
   import crypto from 'node:crypto';
   import { Injectable } from '@nestjs/common';
   import { CreateOrderData, InputOrderData, ContactInfo } from './type';
   
   interface SfResponse {
     apiResponseID: string;
     apiErrorMsg: string;
     apiResultCode: string;
     apiResultData: string;
     succ?: string;
   }
   //  æ˜¯å¦æµ‹è¯•æ²™ç®±ç¯å¢ƒ
   const isSbox = process.env.SF_SBOX == 'true';
   
   export class SfService {
     private isSbox: boolean = isSbox;
     private headers: { 'Content-Type': string } = { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' };
     private partnerID: string = 'DY54335Y4Z3'; // 9888 : DY345454N
     private checkWord: string = '';
     private monthlyCard: string = '';
     private createOrderUrl: string = '';
     private logisticsQueryUrl: string = '';
     constructor() {
       this.checkWord = this.isSbox ? 'gi6345TIfk3345vC' : 'BcJ2P9345fOpG1';
       this.monthlyCard = this.isSbox ? '348908904567' : '34890890076';
       this.createOrderUrl = this.isSbox ? 'https://sfapi-sbox.sf-express.com/std/service' : 'https://bspgw.sf-express.com/std/service';
       this.logisticsQueryUrl = this.isSbox ? 'https://sfapi-sbox.sf-express.com/std/service' : 'https://sfapi.sf-express.com/std/service';
     }
   
     sign(msgDataStr: string, timestamp: number): string {
       const text = msgDataStr + timestamp + this.checkWord;
       const toVerifyText = encodeURIComponent(text).replace(/%20/g, '+');
       const md5 = crypto.createHash('md5').update(toVerifyText, 'utf8').digest().toString('base64');
       return md5;
     }
   
     async getOAuth2Token() {
       const url = this.isSbox ? 'https://sfapi-sbox.sf-express.com/oauth2/accessToken' : 'https://sfapi.sf-express.com/oauth2/accessToken';
       const body = new URLSearchParams({
         partnerID: this.partnerID,
         secret: this.checkWord,
         grantType: 'password',
       });
       const res = await fetch(url, { method: 'POST',  headers: this.headers,  body });
       if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
       const { accessToken } = await res.json();
       if (!accessToken)  throw new Error('è·å–accessTokenå¤±è´¥');
       return accessToken;
     }
   
     generateBaseData({ serviceCode, msgData }: { serviceCode: string; msgData: any }) {
       const timestamp = Date.now();
       const uuid = uuidv4();
       const msgDataStr = JSON.stringify(msgData);
       const msgDigest = this.sign(msgDataStr, timestamp);
       return {
         partnerID: this.partnerID,
         timestamp: timestamp.toString(),
         requestID: uuid,
         serviceCode,
         msgData: msgDataStr,
         msgDigest,
       };
     }
   
     //  ä¸‹å•  ä¼ªä»£ç 
     async createOrder(data: InputOrderData): Promise<any> {
       const { contactInfo, isMonthlyCard, ...rest } = data;
       const newContactInfo = { ...contactInfo,  contactType: 2,  country: 'CN' };
       const monthlyCard = isMonthlyCard ? this.monthlyCard : undefined;
       const msgData: CreateOrderData = {
         ...rest,
         contactInfoList: [
           newContactInfo,
           {
             address: 'ç¦å»ºçœæ³‰å·å¸‚ä¸°æ³½åŒº345',
             contact: 'ç‹äºŒå°',
             contactType: 1,
             country: 'CN',
             company: 'æ³‰å·å°äºŒç§‘æŠ€æœ‰é™å…¬å¸',
             mobile: '1832455641',
           },
         ],
         language: 'zh-CN',
         monthlyCard,
         cargoDetails: data?.cargoDetails || [{ name: 'ç›¸æœº' }],
         isReturnRoutelabel: 1,
         expressTypeId: data?.expressTypeId || 2,
         payMethod: data?.payMethod || 1,
       };
       const baseData = this.generateBaseData({ serviceCode: 'EXP_RECE_CREATE_ORDER', msgData });
       const res = await this.fetchWrap(this.createOrderUrl, baseData);
       const waybillNo = res?.msgData?.waybillNoInfoList[0]?.waybillNo;
       if (waybillNo) return { waybillNo };
       return { error: res };
     }
   
     //  æ ¹æ®å•å· æŸ¥è¯¢ ç‰©æµ
     async LogisticsQuery(waybillNo: string): Promise<any> {
       const msgData = {
         language: 0, //  0ï¼šä¸­æ–‡ 1ï¼šè‹±æ–‡ 2ï¼šç¹ä½“
         trackingType: 1, // 1. é¡ºä¸°è¿å•å·  2. å®¢æˆ·è®¢å•å·
         trackingNumber: [waybillNo],
       };
       const baseData = this.generateBaseData({ serviceCode: 'EXP_RECE_SEARCH_ROUTES', msgData });
       const res = await this.fetchWrap(this.logisticsQueryUrl, baseData);
       const newRes = res?.msgData?.routeResps[0];
       if (newRes?.mailNo) {
         return newRes;
       } else {
         return res;
       }
     }
   
     async cancelOrder(orderId: string) {
       const msgData = {  orderId,  dealType: 2   };
       const baseData = this.generateBaseData({ serviceCode: 'EXP_RECE_UPDATE_ORDER', msgData });
       const res = await this.fetchWrap(this.createOrderUrl, baseData);
       if (res?.msgData?.success) {
         return { success: true };
       } else {
         return { error: res };
       }
     }
   
     async fetchWrap(url: string, baseData: Record<string, string>) {
       const body = new URLSearchParams(baseData).toString();
       try {
         const res = await fetch(url, {  method: 'POST', headers: this.headers,  body  });
         if (!res.ok)  return { error: 'ç½‘ç»œè¯·æ±‚å¼‚å¸¸', message: res?.status };
         const data: SfResponse = await res.json();
         if (data?.apiResultCode) {
           if (data?.apiResultCode == 'A1000' && data.apiResultData) {
             // ç»Ÿä¸€æ¥å…¥å¹³å°æ ¡éªŒæˆåŠŸï¼Œè°ƒç”¨åç«¯æœåŠ¡æˆåŠŸï¼› æ³¨æ„ï¼šä¸ä»£è¡¨åç«¯ä¸šåŠ¡å¤„ç†æˆåŠŸï¼Œå®é™…ä¸šåŠ¡å¤„ç†ç»“æœï¼Œ éœ€è¦æŸ¥çœ‹å“åº”å±æ€§apiResultDataä¸­çš„è¯¦ç»†ç»“æœ
             const resData = JSON.parse(data.apiResultData); //  è¿”å›çš„æ•°æ®æ˜¯jsonå­—ç¬¦ä¸²ï¼Œéœ€è¦è§£æ  //  success è¿”å›  true æˆ– false
             if (resData?.success) {
               return resData;
             } else {
               return { errMsg: 'è¿”å›ç»“æœå¤±è´¥', error: resData };
             }
           } else {
             return { error: 'é¡ºä¸°æ¥å£è°ƒç”¨è¿”å›ç»“æœå¼‚å¸¸', statusMsg: this.switchStatusMessage(data.apiResultCode), message: data?.apiErrorMsg };
           }
         } else {
           return { error: 'é¡ºä¸°æ¥å£å“åº”å¤±è´¥' };
         }
       } catch (error) {
         console.log('error-------------------------', error);
         return { error: 'ç½‘ç»œè¯·æ±‚å¼‚å¸¸', message: error.message };
       }
     }
   
     switchStatusMessage(status: string) {
       let message = '';
       switch (status) {
         case 'A1001':
           message = 'å¿…ä¼ å‚æ•°ä¸å¯ä¸ºç©º';
           break;
         case 'A1002':
           message = 'è¯·æ±‚æ—¶æ•ˆå·²è¿‡æœŸ';
           break;
         case 'A1003':
           message = 'IPæ— æ•ˆ';
           break;
         case 'A1004':
           message = 'æ— å¯¹åº”æœåŠ¡æƒé™';
           break;
         case 'A1005':
           message = 'æµé‡å—æ§';
           break;
         case 'A1006':
           message = 'æ•°å­—ç­¾åæ— æ•ˆ';
           break;
         case 'A1007':
           message = 'é‡å¤è¯·æ±‚';
           break;
         case 'A1008':
           message = 'æ•°æ®è§£å¯†å¤±è´¥';
           break;
         case 'A1009':
           message = 'ç›®æ ‡æœåŠ¡å¼‚å¸¸æˆ–ä¸å¯è¾¾';
           break;
         case 'A1099':
           message = 'ç³»ç»Ÿå¼‚å¸¸';
           break;
         default:
           message = 'æœªçŸ¥é”™è¯¯';
       }
       return message;
     }
   }
   
   
   ```

   



































