é¡ºä¸°ä¸‹å•åŠäº‘æ‰“å°æ¥å£å¯¹æ¥(jsç‰ˆ)

##### [é¡ºä¸°å¼€æ”¾å¹³å°](https://open.sf-express.com/)æ³¨å†Œè´¦å·å¹¶è®¤è¯, æ–°å»ºå¼€å‘è€…åº”ç”¨,é€‰æ‹©ç›¸åº”æ¥å£åˆ†ç±», å…³è”API, é€‰æ‹©éœ€è¦å¼€å‘çš„æ¥å£;æ‰€æœ‰æ¥å£éœ€è¿›è¡Œæ²™ç®±æµ‹è¯•, æˆåŠŸ3æ¬¡åæ‰å¯ä»¥ä¸Šçº¿ç”Ÿäº§. [å‚è€ƒæ–‡ç« ](https://blog.csdn.net/qq_18948359/article/details/137097749)

#### ä¸‹å•æ¥å£

1. ä¸‹å•è¯¦ç»†[è¯´æ˜æ–‡æ¡£]([é¡ºä¸°å¼€æ”¾å¹³å°](https://open.sf-express.com/Api/ApiDetails?level3=393&interName=ä¸‹è®¢å•æ¥å£-EXP_RECE_CREATE_ORDER)), æ•°æ®æœ‰2ç§ç­¾ååŠ å¯†æ–¹å¼, å¯ä»¥äºŒé€‰ä¸€: æ•°å­—ç­¾åå’ŒOAuth2

2. æ•°æ®æ„é€ /æ ¼å¼è½¬æ¢/[æ•°å­—ç­¾åè®¤è¯](https://open.sf-express.com/developSupport/976720?authId=1)

   ```ts
   import { v4 as uuidv4 } from 'uuid';
   import crypto from 'crypto'; 
   sign(msgDataStr: string, timestamp: number): string {
       const text = msgDataStr + timestamp + this.checkWord;
       const toVerifyText = encodeURIComponent(text).replace(/%20/g, '+');
       const md5 = crypto.createHash('md5').update(toVerifyText,'utf8').digest().toString('base64');
       return md5;
     }
   
   generateBaseData(msgData: object) {
       const timestamp = Date.now();
       const uuid = uuidv4();
       const msgDataStr = JSON.stringify(msgData);
       const msgDigest = this.sign(msgDataStr, timestamp);
       const baseData =  {
         partnerID: 'GVHUF78678G', // å®¢æˆ·ç¼–å·
         serviceCode: 'EXP_RECE_CREATE_ORDER',  // ä¸šåŠ¡ç±»å‹
         timestamp: timestamp.toString(),
         requestID: uuid,
         msgData: msgDataStr,
         msgDigest,
       };
       const body = new URLSearchParams(baseData).toString()
       return body
     }
   ```

3. è¯·æ±‚ä¸‹å•

   ```ts
    async createOrder(msgData: object): Promise<any> {
        const createOrderUrl = this.isSbox ? 'https://sfapi-sbox.sf-express.com/std/service' : 'https://bspgw.sf-express.com/std/service';
        const body = generateBaseData(data)
           const res = await fetch(createOrderUrl, {
         method: 'POST',
         headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
         body,
       });
       if (!res.ok) {
         throw new Error(`HTTP error! Status: ${res.status}`);
       }
       return await res.json();
   }
   //  createOrderå“åº”æ•°æ®åœ¨apiResultDataä¸­, éœ€è¦JSON parse
   //  å¿«é€’å•å·åœ¨JSON.parse(apiResultData)?.msgData?.waybillNoInfoList[0]?.waybillNo
   ```

4. [OAuth2è®¤è¯è¯´æ˜](https://open.sf-express.com/developSupport/976720?authId=0), æ³¨æ„æ²™ç®±ç”¨æ²™ç®±tokenå’Œè®¢å•å·,ç”Ÿäº§ç”¨ç”Ÿäº§tokenå’Œè®¢å•å·

   ```ts
    async getOAuth2Token() {
       const url = this.isSbox ? 'https://sfapi-sbox.sf-express.com/oauth2/accessToken' : 'https://sfapi.sf-express.com/oauth2/accessToken';
       const body = new URLSearchParams({
         partnerID:  'GVHUF78678G', // å®¢æˆ·ç¼–å·
         secret: 'checkWordsdgds345',  // æ ¡éªŒç 
         grantType: 'password',  // å›ºå®šå­—ç¬¦
       });
       const res = await fetch(url, {
         method: 'POST',
         headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
         body,
       });
       if (!res.ok) {
         throw new Error(`HTTP error! Status: ${res.status}`);
       }
       const { accessToken } = await res.json();
       if (!accessToken) {
         throw new Error('è·å–accessTokenå¤±è´¥');
       }
       return accessToken;
     }
   
   ```



#### æ‰“å°é¢å•æ¥å£

1. äº‘æ‰“å°é¢å•æ‰“å°æ’ä»¶æ¥å£, å‰ç½®æ¡ä»¶: æ‰“å°æœºè¿æ¥ç”µè„‘,è£…å¥½é©±åŠ¨, å®‰è£…`é¡ºä¸°äº‘æ‰“å°æ’ä»¶`, [å‰ç«¯SDKåŒ…](https://scp-tcdn.sf-express.com/prd/sdk/lodop/2.7/SCPPrint.js), å³é”®ä¿å­˜ä¸ç„¶ä¼šæœ‰ç¼–ç é—®é¢˜, ([å®˜æ–¹æ–‡æ¡£](https://open.sf-express.com/Api/ApiDetails?level3=324&interName=äº‘æ‰“å°é¢å•æ‰“å°æ’ä»¶æ¥å£-COM_RECE_CLOUD_PRINT_PARSEDDATA))

2. æ­¤æ’ä»¶æ¥å£apiæ˜¯ç›´æ¥åœ¨å‰ç«¯ä½¿ç”¨SDKå‘èµ·

   ```ts
   //  SCPPrintå‡½æ•°æ¥è‡ªSDKåŒ…,è²Œä¼¼æŒ‚è½½åœ¨å…¨å±€windowä¸Š
   const sfPrint = new SCPPrint({ partnerID: 'DYJ4554YUI6Z3', 
                  // env: 'sbox'
        })
   const accessToken = await getOAuth2Token() // å‘åç«¯è¯·æ±‚token
   const requestID = uuidv4()  // å”¯ä¸€ID éšæœºæ•°ä¹Ÿå¯ä»¥ ç”¨äºæº¯æº
     sfPrint.print(
       {
         requestID,
         accessToken,
         templateCode: 'fm_76130_standard_DYJ4554YUI6Z3', // ç±»ä¼¼ï¼šfm_76130_standard_{partnerId}
         documents: [
           {
             masterWaybillNo: 'SF7444497906873'  // è¦æ‰“å°çš„é¡ºä¸°å•å·
           }
         ]
       },
       (res) => {   // å›è°ƒå‡½æ•°
           if (res?.code === 1) {
           console.log('ğŸš€ ~ xzz: æ‰“å°æˆåŠŸ ~ res')
         }
         
       }
     )
   ```

3. å®ç°åŸç†(åˆæ­¥ç†è§£): sdkæºå¸¦tokenå‘èµ·è¯·æ±‚ç»™é¡ºä¸°å®˜æ–¹æ¥å£, æ¥å£æ ¸å¯¹èº«ä»½ä¿¡æ¯,æŸ¥æ‰¾åˆ°å½“å‰è®¢å•ä¿¡æ¯è¿”å›ç»™sdk,  ç”µè„‘å®‰è£…çš„äº‘æ‰“å°æ’ä»¶æœ‰å»ºç«‹websocketé€šä¿¡,é»˜è®¤8000ç«¯å£,sdkå°†å¾…æ‰“å°ä¿¡æ¯å‘é€ç»™ws,ä»è€Œå®ç°æ‰“å°.



































